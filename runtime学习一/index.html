<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>runtimeå­¦ä¹ ä¸€ | yahaoâ€˜s note</title>
  <meta name="keywords" content="">
  <meta name="description" content="runtimeå­¦ä¹ ä¸€ | yahaoâ€˜s note">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="description" content="Welcome to Hexo! This is your very first post. Check documentation for more info. If you get any problems when using Hexo, you can find the answer in troubleshooting or you can ask me on GitHub. Quick">
<meta property="og:type" content="article">
<meta property="og:title" content="Hello World">
<meta property="og:url" content="https://xieyahao.github.io/blog/hello-world/index.html">
<meta property="og:site_name" content="yahaoâ€˜s note">
<meta property="og:description" content="Welcome to Hexo! This is your very first post. Check documentation for more info. If you get any problems when using Hexo, you can find the answer in troubleshooting or you can ask me on GitHub. Quick">
<meta property="og:locale" content="zh">
<meta property="article:published_time" content="2020-05-29T10:29:00.486Z">
<meta property="article:modified_time" content="2020-05-29T10:29:00.486Z">
<meta name="twitter:card" content="summary">


<link rel="icon" href="/img/avatar.jpg">

<link href="/blog/css/style.css?v=1.1.0" rel="stylesheet">

<link href="/blog/css/hl_theme/atom-light.css?v=1.1.0" rel="stylesheet">

<link href="//cdn.jsdelivr.net/npm/animate.css@4.1.0/animate.min.css" rel="stylesheet">

<script src="//cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
<script src="/blog/js/titleTip.js?v=1.1.0" ></script>

<script src="//cdn.jsdelivr.net/npm/highlightjs@9.16.2/highlight.pack.min.js"></script>
<script>
    hljs.initHighlightingOnLoad();
</script>

<script src="//cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js"></script>



<script src="//cdn.jsdelivr.net/npm/jquery.cookie@1.4.1/jquery.cookie.min.js" ></script>

<script src="/blog/js/iconfont.js?v=1.1.0" ></script>

<meta name="generator" content="Hexo 4.2.1"></head>
<div style="display: none">
  <input class="theme_disqus_on" value="false">
  <input class="theme_preload_comment" value="">
  <input class="theme_blog_path" value="/blog">
  <input id="theme_shortcut" value="true" />
</div>


<body>
<aside class="nav">
    <div class="nav-left">
        <a href="/blog/" class="avatar_target">
    <img class="avatar" src="/blog/img/avatar.jpg" />
</a>
<div class="author">
    <span></span>
</div>

<div class="icon">
    
</div>




<ul>
    <li><div class="all active" data-rel="All">All<small>(3)</small></div></li>
    
</ul>
<div class="left-bottom">
    <div class="menus">
    
    
    
    
    </div>
    <div><a class="about  hasFriend  site_url"  href="/about">About</a><a style="width: 50%"  class="friends">Friends</a></div>
</div>
<input type="hidden" id="yelog_site_posts_number" value="3">

<div style="display: none">
    <span id="busuanzi_value_site_uv"></span>
    <span id="busuanzi_value_site_pv"></span>
</div>

    </div>
    <div class="nav-right">
        <div class="friends-area">
    <div class="friends-title">
        Links
        <i class="iconfont icon-left"></i>
    </div>
    <div class="friends-content">
        <ul>
            
        </ul>
    </div>
</div>
        <div class="title-list">
    <div class="right-top">
        <div id="default-panel">
            <i class="iconfont icon-search" data-title="æœç´¢ å¿«æ·é”® i"></i>
            <div class="right-title">All</div>
            <i class="iconfont icon-file-tree" data-title="åˆ‡æ¢åˆ°å¤§çº²è§†å›¾ å¿«æ·é”® w"></i>
        </div>
        <div id="search-panel">
            <i class="iconfont icon-left" data-title="è¿”å›"></i>
            <input id="local-search-input" />
            <label class="border-line" for="input"></label>
            <i class="iconfont icon-case-sensitive" data-title="å¤§å°å†™æ•æ„Ÿ"></i>
            <i class="iconfont icon-tag" data-title="æ ‡ç­¾"></i>
        </div>
        <div id="outline-panel" style="display: none">
            <div class="right-title">å¤§çº²</div>
            <i class="iconfont icon-list" data-title="åˆ‡æ¢åˆ°æ–‡ç« åˆ—è¡¨"></i>
        </div>
    </div>

    <div class="tags-list">
    <input id="tag-search" />
    <div class="tag-wrapper">
        
    </div>

</div>

    
    <nav id="title-list-nav">
        
        <a  class="All "
           href="/blog/hello-world/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="Hello World">Hello World</span>
            <span class="post-date" title="2020-05-29 18:29:00">2020/05/29</span>
        </a>
        
        <a  class="All "
           href="/blog/block%E7%9A%84%E6%9C%AC%E8%B4%A8/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="Hello World">Hello World</span>
            <span class="post-date" title="2020-05-29 18:29:00">2020/05/29</span>
        </a>
        
        <a  class="All "
           href="/blog/runtime%E5%AD%A6%E4%B9%A0%E4%B8%80/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="runtimeå­¦ä¹ ä¸€">runtimeå­¦ä¹ ä¸€</span>
            <span class="post-date" title="2020-05-28 15:43:26">2020/05/28</span>
        </a>
        
        <div id="no-item-tips">

        </div>
    </nav>
    <div id="outline-list">
    </div>
</div>
    </div>
    <div class="hide-list">
        <div class="semicircle" data-title="åˆ‡æ¢å…¨å± å¿«æ·é”® s">
            <div class="brackets first"><</div>
            <div class="brackets">&gt;</div>
        </div>
    </div>
</aside>
<div id="post">
    <div class="pjax">
        <article id="post-runtimeå­¦ä¹ ä¸€" class="article article-type-post" itemscope itemprop="blogPost">
    
        <h1 class="article-title">runtimeå­¦ä¹ ä¸€</h1>
    
    <div class="article-meta">
        
        
        
        
    </div>
    <div class="article-meta">
        
            Created At : <time class="date" title='Updated At: 2020-06-07 10:30:15'>2020-05-28 15:43</time>
        
    </div>
    <div class="article-meta">
        
        
        <span id="busuanzi_container_page_pv">
            Views ğŸ‘€ :<span id="busuanzi_value_page_pv">
                <span class="count-comment">
                    <span class="spinner">
                      <div class="cube1"></div>
                      <div class="cube2"></div>
                    </span>
                </span>
            </span>
        </span>
        
        
    </div>
    
    <div class="toc-ref">
    
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#runtime"><span class="toc-text">runtime</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#runtime-åˆå«è¿è¡Œæ—¶ï¼Œæ˜¯ä¸€å¥—åº•å±‚Cè¯­è¨€APiã€‚"><span class="toc-text">runtime åˆå«è¿è¡Œæ—¶ï¼Œæ˜¯ä¸€å¥—åº•å±‚Cè¯­è¨€APiã€‚</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ä¸€ã€ç±»ã€å¯¹è±¡-ã€å‡½æ•°"><span class="toc-text">ä¸€ã€ç±»ã€å¯¹è±¡ ã€å‡½æ•°</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-ã€ç±»-objc-class"><span class="toc-text">1 ã€ç±» objc_class</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2ã€å…ƒç±»ï¼ˆmeta-classï¼‰"><span class="toc-text">2ã€å…ƒç±»ï¼ˆmeta classï¼‰</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3ã€å¯¹è±¡id-â€“-gt-objc-object"><span class="toc-text">3ã€å¯¹è±¡id â€“&gt; objc_object</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4ã€objc-classä¸­-cache-t-çš„å®ç°"><span class="toc-text">4ã€objc_classä¸­ cache_t çš„å®ç°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-class-data-bits-tçš„å…·ä½“å®ç°"><span class="toc-text">5.class_data_bits_tçš„å…·ä½“å®ç°</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#aã€class-rw-t-ä¸-class-ro-t"><span class="toc-text">aã€class_rw_t ä¸ class_ro_t</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#aaã€åˆå°è±¡"><span class="toc-text">aaã€åˆå°è±¡</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#bbã€class-ro-t-ç¼–è¯‘æœŸ"><span class="toc-text">bbã€class_ro_t ç¼–è¯‘æœŸ</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ccã€class-rw-tç”Ÿæˆæ—¶æœº"><span class="toc-text">ccã€class_rw_tç”Ÿæˆæ—¶æœº</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ddã€åˆ†ç±»æ–¹æ³•åŠ è½½åˆ°class-rw-tçš„æµç¨‹"><span class="toc-text">ddã€åˆ†ç±»æ–¹æ³•åŠ è½½åˆ°class_rw_tçš„æµç¨‹</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#objc-init"><span class="toc-text">_objc_init</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#ç„¶åï¼šmap-images-å‡½æ•°"><span class="toc-text">ç„¶åï¼šmap_images å‡½æ•°</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#read-images"><span class="toc-text">_read_images</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#load-images"><span class="toc-text">load_images</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#loadable-classesæ˜¯æ€ä¹ˆç®¡ç†çš„ï¼Ÿ"><span class="toc-text">loadable_classesæ˜¯æ€ä¹ˆç®¡ç†çš„ï¼Ÿ</span></a></li></ol></li></ol></li></ol></li></ol></li></ol></li></ol>
    
<style>
    .left-col .switch-btn,
    .left-col .switch-area {
        display: none;
    }
    .toc-level-3 i,
    .toc-level-3 ol {
        display: none !important;
    }
</style>
</div>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="runtime"><a href="#runtime" class="headerlink" title="runtime"></a>runtime</h1><h2 id="runtime-åˆå«è¿è¡Œæ—¶ï¼Œæ˜¯ä¸€å¥—åº•å±‚Cè¯­è¨€APiã€‚"><a href="#runtime-åˆå«è¿è¡Œæ—¶ï¼Œæ˜¯ä¸€å¥—åº•å±‚Cè¯­è¨€APiã€‚" class="headerlink" title="runtime åˆå«è¿è¡Œæ—¶ï¼Œæ˜¯ä¸€å¥—åº•å±‚Cè¯­è¨€APiã€‚"></a>runtime åˆå«è¿è¡Œæ—¶ï¼Œæ˜¯ä¸€å¥—åº•å±‚Cè¯­è¨€APiã€‚</h2><h2 id="ä¸€ã€ç±»ã€å¯¹è±¡-ã€å‡½æ•°"><a href="#ä¸€ã€ç±»ã€å¯¹è±¡-ã€å‡½æ•°" class="headerlink" title="ä¸€ã€ç±»ã€å¯¹è±¡ ã€å‡½æ•°"></a>ä¸€ã€ç±»ã€å¯¹è±¡ ã€å‡½æ•°</h2><h3 id="1-ã€ç±»-objc-class"><a href="#1-ã€ç±»-objc-class" class="headerlink" title="1 ã€ç±» objc_class"></a>1 ã€ç±» objc_class</h3><p> åœ¨OCçš„ä¸–ç•Œä¸­ï¼Œé™¤äº†NSProxyç±»ä»¥å¤–ï¼Œæ‰€æœ‰çš„ç±»éƒ½æ˜¯NSObjectçš„å­ç±»ã€‚åœ¨NSObjectä¸­è§‚å¯Ÿåˆ°ï¼Œ</p>
<img src="/blog/runtime%E5%AD%A6%E4%B9%A0%E4%B8%80/NSObject%E7%B1%BB%E5%AE%9A%E4%B9%89%E6%88%AA%E5%9B%BE.png" class="" title="NSObjectç±»å®šä¹‰æˆªå›¾.png">

<p>çœ‹ä¸‹class</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/// An opaque type that represents an Objective-C class.</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">objc_class</span> *<span class="title">Class</span>;</span></span><br></pre></td></tr></table></figure>

<p>Objc2.0 åï¼Œobjc_classçš„å®šä¹‰ï¼š</p>
<img src="/blog/runtime%E5%AD%A6%E4%B9%A0%E4%B8%80/objc_class%E5%AE%9A%E4%B9%89.png" class="" title="objc_classå®šä¹‰.png">
<img src="/blog/runtime%E5%AD%A6%E4%B9%A0%E4%B8%80/objc_class%E7%B1%BB%E5%9B%BE.png" class="" title="objc_classç±»å›¾.png">

<h3 id="2ã€å…ƒç±»ï¼ˆmeta-classï¼‰"><a href="#2ã€å…ƒç±»ï¼ˆmeta-classï¼‰" class="headerlink" title="2ã€å…ƒç±»ï¼ˆmeta classï¼‰"></a>2ã€å…ƒç±»ï¼ˆmeta classï¼‰</h3><p>å…ƒç±»çš„å¼•å…¥ï¼Œæ˜¯ä¸ºäº†å’Œå¯¹è±¡æŸ¥æ‰¾æ–¹æ³•çš„æœºåˆ¶ä¸€è‡´ã€‚<br>å¯¹è±¡çš„å®ä¾‹æ–¹æ³•è°ƒç”¨æ—¶ï¼Œé€šè¿‡å¯¹è±¡çš„ isa åœ¨ç±»ä¸­è·å–æ–¹æ³•çš„å®ç°ã€‚ç±»å¯¹è±¡çš„ç±»æ–¹æ³•è°ƒç”¨æ—¶ï¼Œé€šè¿‡ç±»çš„ isa åœ¨å…ƒç±»ä¸­è·å–æ–¹æ³•çš„å®ç°ã€‚</p>
<img src="/blog/runtime%E5%AD%A6%E4%B9%A0%E4%B8%80/isa_class_metaClass.png" class="" title="isa_class_metaClass.png">

<p>a.Root class (class)å…¶å®å°±æ˜¯NSObjectï¼ŒNSObjectæ˜¯æ²¡æœ‰è¶…ç±»çš„ï¼Œæ‰€ä»¥Root class(class)çš„superclassæŒ‡å‘nilã€‚<br>b.æ¯ä¸ªClasséƒ½æœ‰ä¸€ä¸ªisaæŒ‡é’ˆæŒ‡å‘å”¯ä¸€çš„Meta class<br>c.Root class(meta)çš„superclassæŒ‡å‘Root class(class)ï¼Œä¹Ÿå°±æ˜¯NSObjectï¼Œå½¢æˆä¸€ä¸ªå›è·¯ã€‚<br>d.æ¯ä¸ªMeta classçš„isaæŒ‡é’ˆéƒ½æŒ‡å‘Root class (meta)ã€‚</p>
<h3 id="3ã€å¯¹è±¡id-â€“-gt-objc-object"><a href="#3ã€å¯¹è±¡id-â€“-gt-objc-object" class="headerlink" title="3ã€å¯¹è±¡id â€“&gt; objc_object"></a>3ã€å¯¹è±¡id â€“&gt; objc_object</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">objc_object</span> &#123;</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line"><span class="keyword">isa_t</span> isa;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="comment">/// initIsa() should be used to init the isa of new objects only.</span></span><br><span class="line"><span class="comment">/// If this object already has an isa, use changeIsa() for correctness.</span></span><br><span class="line"><span class="comment">// initInstanceIsa(): objects with no custom RR/AWZ</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">initIsa</span><span class="params">(Class cls <span class="comment">/*indexed=false*/</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">initInstanceIsa</span><span class="params">(Class cls, <span class="keyword">bool</span>    hasCxxDtor)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">initIsa</span><span class="params">(Class newCls, <span class="keyword">bool</span> indexed, <span class="keyword">bool</span> hasCxxDtor)</span></span>;</span><br><span class="line">ï½</span><br></pre></td></tr></table></figure>
<p>isa_t æ˜¯ä¸€ä¸ªunionè”åˆä½“ã€‚åˆå§‹åŒ–isaæ—¶ï¼Œå¯¹äº64ä½çš„å¼•å…¥ï¼Œä¸ºäº†èŠ‚çœå†…å­˜å’Œæé«˜æ‰§è¡Œæ•ˆç‡ï¼Œè‹¹æœæå‡ºäº†tagged pointer.</p>
<h3 id="4ã€objc-classä¸­-cache-t-çš„å®ç°"><a href="#4ã€objc-classä¸­-cache-t-çš„å®ç°" class="headerlink" title="4ã€objc_classä¸­ cache_t çš„å®ç°"></a>4ã€objc_classä¸­ cache_t çš„å®ç°</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cache_t</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">bucket_t</span> *_<span class="title">buckets</span>;</span></span><br><span class="line">  <span class="keyword">mask_t</span> _mask;</span><br><span class="line">  <span class="keyword">mask_t</span> _occupied;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="keyword">uint32_t</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">uint32_t</span> <span class="keyword">mask_t</span>;  <span class="comment">/// x86_64 &amp; arm64 asm are less efficient with 16-bits</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">long</span>  <span class="keyword">uintptr_t</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">uintptr_t</span> <span class="keyword">cache_key_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bucket_t</span> &#123;</span></span><br><span class="line">  <span class="keyword">private</span>:</span><br><span class="line">  <span class="keyword">cache_key_t</span> _key;</span><br><span class="line">  IMP _imp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src="/blog/runtime%E5%AD%A6%E4%B9%A0%E4%B8%80/cache_t%E7%B1%BB%E5%9B%BE.png" class="" title="cache_tç±»å›¾.png">
<p>maskï¼šåˆ†é…ç”¨æ¥ç¼“å­˜bucketçš„æ€»æ•°ã€‚<br>occupiedï¼šè¡¨æ˜ç›®å‰å®é™…å ç”¨çš„ç¼“å­˜bucketçš„ä¸ªæ•°ã€‚</p>
<p>bucket_tçš„ç»“æ„ä½“ä¸­å­˜å‚¨äº†ä¸€ä¸ªunsigned longå’Œä¸€ä¸ªIMPã€‚IMPæ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼ŒæŒ‡å‘äº†ä¸€ä¸ªæ–¹æ³•çš„å…·ä½“å®ç°ã€‚<br>Cacheçš„ä½œç”¨ä¸»è¦æ˜¯ä¸ºäº†ä¼˜åŒ–æ–¹æ³•è°ƒç”¨çš„æ€§èƒ½ã€‚ä½¿ç”¨Cacheæ¥ç¼“å­˜ç»å¸¸è°ƒç”¨çš„æ–¹æ³•ï¼Œå½“è°ƒç”¨æ–¹æ³•æ—¶ï¼Œä¼˜å…ˆåœ¨CacheæŸ¥æ‰¾ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œå†åˆ°methodListsæŸ¥æ‰¾ã€‚</p>
<h3 id="5-class-data-bits-tçš„å…·ä½“å®ç°"><a href="#5-class-data-bits-tçš„å…·ä½“å®ç°" class="headerlink" title="5.class_data_bits_tçš„å…·ä½“å®ç°"></a>5.class_data_bits_tçš„å…·ä½“å®ç°</h3><img src="/blog/runtime%E5%AD%A6%E4%B9%A0%E4%B8%80/class_rw_t%E7%9A%84%E4%BD%BF%E7%94%A8.png" class="" title="class_rw_tçš„ä½¿ç”¨.png">

<h4 id="aã€class-rw-t-ä¸-class-ro-t"><a href="#aã€class-rw-t-ä¸-class-ro-t" class="headerlink" title="aã€class_rw_t ä¸ class_ro_t"></a>aã€class_rw_t ä¸ class_ro_t</h4><img src="/blog/runtime%E5%AD%A6%E4%B9%A0%E4%B8%80/class_rw_t%E4%B8%8Eclass_ro_t1.png" class="" title="class_rw_tä¸class_ro_t1.png.png">

<h5 id="aaã€åˆå°è±¡"><a href="#aaã€åˆå°è±¡" class="headerlink" title="aaã€åˆå°è±¡"></a>aaã€åˆå°è±¡</h5><p>class_ro_tå­˜å‚¨äº†å½“å‰ç±»åœ¨ç¼–è¯‘æœŸå°±å·²ç»ç¡®å®šäº†çš„å±æ€§ã€æ–¹æ³•å’Œéµå¾ªçš„åè®®ï¼Œé‡Œé¢æ˜¯æ²¡æœ‰categoryçš„æ–¹æ³•ã€‚è¿è¡Œæ—¶æ·»åŠ çš„æ–¹æ³•å°†ä¼šå­˜å‚¨åœ¨è¿è¡Œæ—¶ç”Ÿæˆçš„class_rw_tä¸­ã€‚class_ro_tå®šä¹‰æºç ï¼š</p>
<img src="/blog/runtime%E5%AD%A6%E4%B9%A0%E4%B8%80/class_ro_t%E5%AE%9A%E4%B9%89.png" class="" title="class_ro_tå®šä¹‰">


<p>class_rw_tå®šä¹‰æºç </p>
<img src="/blog/runtime%E5%AD%A6%E4%B9%A0%E4%B8%80/class_rw_t%E5%AE%9A%E4%B9%89.png" class="" title="class_rw_tå®šä¹‰">

<p>æ€»ç»“èµ·æ¥çš„ç±»å›¾</p>
<img src="/blog/runtime%E5%AD%A6%E4%B9%A0%E4%B8%80/class_data_bits_t%E7%B1%BB%E5%9B%BE.png" class="" title="class_data_bits_tç±»å›¾.png">


<h5 id="bbã€class-ro-t-ç¼–è¯‘æœŸ"><a href="#bbã€class-ro-t-ç¼–è¯‘æœŸ" class="headerlink" title="bbã€class_ro_t ç¼–è¯‘æœŸ"></a>bbã€class_ro_t ç¼–è¯‘æœŸ</h5><p>åœ¨ç¼–è¯‘æœŸç±»çš„ç»“æ„ä¸­çš„ class_data_bits_t *dataæŒ‡å‘çš„æ˜¯ä¸€ä¸ª class_ro_t *æŒ‡é’ˆï¼Œ ç±»å›¾å¦‚ä¸‹ï¼š</p>
<img src="/blog/runtime%E5%AD%A6%E4%B9%A0%E4%B8%80/%E7%BC%96%E8%AF%91%E6%9C%9Fbit%E6%8C%87%E5%90%91%E7%B1%BB%E5%9B%BE.png" class="" title="ç¼–è¯‘æœŸbitæŒ‡å‘ç±»å›¾.png">

<h5 id="ccã€class-rw-tç”Ÿæˆæ—¶æœº"><a href="#ccã€class-rw-tç”Ÿæˆæ—¶æœº" class="headerlink" title="ccã€class_rw_tç”Ÿæˆæ—¶æœº"></a>ccã€class_rw_tç”Ÿæˆæ—¶æœº</h5><p>class_rw_tç”Ÿæˆåœ¨è¿è¡Œæ—¶,åœ¨runtimeè¿è¡Œä¹‹åï¼Œå…·ä½“è¯´æ¥æ˜¯åœ¨è¿è¡Œruntimeçš„realizeClass æ–¹æ³•æ—¶ï¼Œä¼šç”Ÿæˆclass_rw_tç»“æ„ä½“ï¼Œè¯¥ç»“æ„ä½“åŒ…å«äº†class_ro_tï¼Œå¹¶ä¸”æ›´æ–°dataéƒ¨åˆ†ï¼Œæ¢æˆclass_rw_tç»“æ„ä½“çš„åœ°å€ã€‚</p>
<p>realizeClasséƒ¨åˆ†æºç </p>
<img src="/blog/runtime%E5%AD%A6%E4%B9%A0%E4%B8%80/realizeClass%E6%BA%90%E7%A0%81.png" class="" title="realizeClassæºç .png">


<p>è¿è¡ŒæœŸbitæŒ‡å‘ç±»å›¾ï¼›</p>
<img src="/blog/runtime%E5%AD%A6%E4%B9%A0%E4%B8%80/%E8%BF%90%E8%A1%8C%E6%9C%9Fbit%E6%8C%87%E5%90%91%E7%B1%BB%E5%9B%BE.png" class="" title="è¿è¡ŒæœŸbitæŒ‡å‘ç±»å›¾.png">

<h5 id="ddã€åˆ†ç±»æ–¹æ³•åŠ è½½åˆ°class-rw-tçš„æµç¨‹"><a href="#ddã€åˆ†ç±»æ–¹æ³•åŠ è½½åˆ°class-rw-tçš„æµç¨‹" class="headerlink" title="ddã€åˆ†ç±»æ–¹æ³•åŠ è½½åˆ°class_rw_tçš„æµç¨‹"></a>ddã€åˆ†ç±»æ–¹æ³•åŠ è½½åˆ°class_rw_tçš„æµç¨‹</h5><p>ç¨‹åºå¯åŠ¨åï¼Œé€šè¿‡ç¼–è¯‘ä¹‹åï¼ŒRuntime ä¼šè¿›è¡Œåˆå§‹åŒ–ï¼Œè°ƒç”¨ _objc_init.</p>
<h6 id="objc-init"><a href="#objc-init" class="headerlink" title="_objc_init"></a>_objc_init</h6><p>1ã€_objc_initç”±dylbé©±åŠ¨ï¼Œè¿™ä¸ªé˜¶æ®µä¼šæ³¨å†Œä¸‰ä¸ªå›è°ƒ,mappedã€initã€unmapped<br>å†å»æ£€æŸ¥æ˜¯å¦æœ‰åˆ†ç±»ï¼ŒåŒæ—¶å°†åˆ†ç±»çš„æ–¹æ³•ï¼Œå±æ€§ï¼Œåè®®åˆ—è¡¨æ•´åˆå­˜å‚¨åœ¨class_rw_tçš„æ–¹æ³•ï¼Œå±æ€§åŠåè®®åˆ—è¡¨ä¸­ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> _objc_init(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">bool</span> initialized = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (initialized) <span class="keyword">return</span>;</span><br><span class="line">    initialized = <span class="literal">true</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// fixme defer initialization until an objc-using image is found?</span></span><br><span class="line">    environ_init(); <span class="comment">//ç¯å¢ƒè°ƒè¯• ä¾‹å¦‚åƒµå°¸æ¨¡å¼è®¾ç½®åï¼Œå°±æ˜¯åœ¨è¿™é‡Œèµ·ä½œç”¨çš„</span></span><br><span class="line">    tls_init(); <span class="comment">//tlsæŒ‡çš„æ˜¯å±€éƒ¨çº¿ç¨‹å­˜å‚¨ï¼Œå¯ä»¥å°†æ•°æ®å­˜å‚¨åœ¨çº¿ç¨‹ä¸€ä¸ªå…¬å…±åŒºåŸŸï¼Œä¾‹å¦‚pthread_setspecific()ï¼Œåœ¨autoreleasepoolå’Œå †æ ˆä¿¡æ¯è·å–æ—¶éƒ½æœ‰æ¶‰åŠ</span></span><br><span class="line">    static_init(); <span class="comment">//æ‰§è¡Œc++é™æ€æ„é€ å‡½æ•°</span></span><br><span class="line">    lock_init(); <span class="comment">//è¿™é‡Œè·å–ä¸¤ä¸ªçš„çº¿ç¨‹ä¼˜å…ˆçº§ åå°ä¼˜å…ˆçº§çº¿ç¨‹ä»¥åŠä¸»çº¿ç¨‹</span></span><br><span class="line">    exception_init(); <span class="comment">//è¿™é‡Œåˆå§‹åŒ–libobjcçš„exceptionå¤„ç†ç³»ç»Ÿ</span></span><br><span class="line"></span><br><span class="line">    _dyld_objc_notify_register(&amp;map_images, load_images, unmap_image);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="ç„¶åï¼šmap-images-å‡½æ•°"><a href="#ç„¶åï¼šmap-images-å‡½æ•°" class="headerlink" title="ç„¶åï¼šmap_images å‡½æ•°"></a>ç„¶åï¼šmap_images å‡½æ•°</h6><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">map_images(<span class="keyword">unsigned</span> count, <span class="keyword">const</span> <span class="keyword">char</span> * <span class="keyword">const</span> paths[],</span><br><span class="line">           <span class="keyword">const</span> struct mach_header * <span class="keyword">const</span> mhdrs[])</span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">rwlock_writer_t</span> <span class="title">lock</span><span class="params">(runtimeLock)</span></span>;</span><br><span class="line">    <span class="keyword">return</span> map_images_nolock(count, paths, mhdrs);</span><br><span class="line">&#125;</span><br><span class="line">`</span><br></pre></td></tr></table></figure>
<p>æ¥ä¸‹æ¥è°ƒç”¨ map_images_nolock.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> </span><br><span class="line">map_images_nolock(<span class="keyword">unsigned</span> mhCount, <span class="keyword">const</span> <span class="keyword">char</span> * <span class="keyword">const</span> mhPaths[],</span><br><span class="line">                  <span class="keyword">const</span> struct mach_header * <span class="keyword">const</span> mhdrs[])</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//.... ç•¥å»ä¸€å¤§å—</span></span><br><span class="line">    <span class="keyword">if</span> (hCount &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        _read_images(hList, hCount, totalClasses, unoptimizedTotalClasses);</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="read-images"><a href="#read-images" class="headerlink" title="_read_images"></a>_read_images</h6><p>è°ƒç”¨ _read_images,è¿™ä¸ªæ–¹æ³•ä¼šè¯»å–æ‰€æœ‰ç±»çš„ç›¸å…³ä¿¡æ¯ï¼Œæ ¹æ®æ³¨é‡Šï¼Œä¸»è¦åšäº†ï¼š<br>_read_images æ–¹æ³•å†™äº†å¾ˆé•¿ï¼Œå…¶å®å°±æ˜¯åšäº†ä¸€ä»¶äº‹ï¼Œå°†Mach-Oæ–‡ä»¶çš„sectionä¾æ¬¡è¯»å–ï¼Œå¹¶æ ¹æ®å†…å®¹åˆå§‹åŒ–runtimeçš„å†…å­˜ç»“æ„ã€‚</p>
<p> 1ã€åŠ è½½æ‰€æœ‰ç±»åˆ°ç±»çš„gdb_objc_realized_classesè¡¨ä¸­ã€‚<br> 2ã€å¯¹æ‰€æœ‰ç±»åšé‡æ˜ å°„ã€‚<br> 3ã€å°†æ‰€æœ‰SELéƒ½æ³¨å†Œåˆ°namedSelectorsè¡¨ä¸­ã€‚<br> 4ã€ä¿®å¤å‡½æ•°æŒ‡é’ˆé—ç•™ã€‚<br> 5ã€å°†æ‰€æœ‰Protocoléƒ½æ·»åŠ åˆ°protocol_mapè¡¨ä¸­ã€‚<br> 6ã€å¯¹æ‰€æœ‰Protocolåšé‡æ˜ å°„ã€‚<br> 7ã€åˆå§‹åŒ–æ‰€æœ‰éæ‡’åŠ è½½çš„ç±»ï¼Œè¿›è¡Œrwã€roç­‰æ“ä½œã€‚<br> 8ã€éå†å·²æ ‡è®°çš„æ‡’åŠ è½½çš„ç±»ï¼Œå¹¶åšåˆå§‹åŒ–æ“ä½œã€‚<br> 9ã€å¤„ç†æ‰€æœ‰Categoryï¼ŒåŒ…æ‹¬Classå’ŒMeta Classã€‚<br> 10ã€åˆå§‹åŒ–æ‰€æœ‰æœªåˆå§‹åŒ–çš„ç±»ã€‚</p>
<h6 id="load-images"><a href="#load-images" class="headerlink" title="load_images"></a>load_images</h6><p>æ„é€ å¥½ class_rw_t ä¹‹åï¼Œload_images è°ƒç”¨ call_load_methods å°±æ˜¯å¼€å§‹è°ƒç”¨ç±»çš„+loadæ–¹æ³•å’Œåˆ†ç±»çš„+loadæ–¹æ³•äº†ã€‚ load_images åœ¨runtimeåˆå§‹åŒ–_objc_initå°±æ³¨å†Œåˆ°dyld,å› æ­¤æ¯å½“æœ‰æ–°çš„é•œåƒimageåŠ è½½æ—¶ï¼Œéƒ½ä¼šæ‰§è¡Œload_imagesè¿›è¡Œå›è°ƒã€‚</p>
<p>loadç±»æ–¹æ³•çš„è°ƒç”¨æ—¶æœºæ¯”mainå‡½æ•°è¿˜è¦é å‰ã€‚loadæ–¹æ³•æ˜¯ç”±ç³»ç»Ÿæ¥è°ƒç”¨çš„ï¼Œå¹¶ä¸”åœ¨æ•´ä¸ªç¨‹åºè¿è¡ŒæœŸé—´ï¼Œåªä¼šè°ƒç”¨ä¸€æ¬¡ï¼Œæ‰€ä»¥å¯ä»¥åœ¨loadæ–¹æ³•ä¸­æ‰§è¡Œä¸€äº›åªæ‰§è¡Œä¸€æ¬¡çš„æ“ä½œã€‚</p>
<p>ä¸€èˆ¬Method Swizzlingéƒ½ä¼šæ”¾åœ¨loadæ–¹æ³•ä¸­æ‰§è¡Œï¼Œè¿™æ ·åœ¨æ‰§è¡Œmainå‡½æ•°å‰ï¼Œå°±å¯ä»¥å¯¹ç±»æ–¹æ³•è¿›è¡Œäº¤æ¢ã€‚å¯ä»¥ç¡®ä¿æ­£å¼æ‰§è¡Œä»£ç æ—¶ï¼Œæ–¹æ³•è‚¯å®šæ˜¯è¢«äº¤æ¢è¿‡çš„ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *</span><br><span class="line"></span><br><span class="line">load_images(<span class="keyword">enum</span> dyld_image_states state, <span class="keyword">uint32_t</span> infoCount,</span><br><span class="line">            <span class="keyword">const</span> struct dyld_image_info infoList[]) &#123;</span><br><span class="line">    <span class="keyword">bool</span> found;</span><br><span class="line">    found = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">uint32_t</span> i = <span class="number">0</span>; i &lt; infoCount; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (hasLoadMethods((<span class="keyword">const</span> headerType *)infoList[i].imageLoadAddress)) &#123;</span><br><span class="line">            found = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!found) <span class="keyword">return</span> nil;</span><br><span class="line">    <span class="function"><span class="keyword">recursive_mutex_locker_t</span> <span class="title">lock</span><span class="params">(loadMethodLock)</span></span>;</span><br><span class="line">     &#123;</span><br><span class="line">        <span class="function"><span class="keyword">rwlock_writer_t</span> <span class="title">lock2</span><span class="params">(runtimeLock)</span></span>;</span><br><span class="line">        found = load_images_nolock(state, infoCount, infoList);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (found) &#123;</span><br><span class="line">        call_load_methods();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> nil;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¼šè¿›å…¥ load_images_nolock æ¥æŸ¥æ‰¾ load æ–¹æ³•</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">load_images_nolock</span><span class="params">(<span class="keyword">enum</span> dyld_image_states state,<span class="keyword">uint32_t</span> infoCount,</span></span></span><br><span class="line"><span class="function"><span class="params">                   <span class="keyword">const</span> struct dyld_image_info infoList[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">bool</span> found = NO;</span><br><span class="line">    <span class="keyword">uint32_t</span> i;</span><br><span class="line">    i = infoCount;</span><br><span class="line">    <span class="keyword">while</span> (i--) &#123;</span><br><span class="line">        <span class="keyword">const</span> headerType *mhdr = (headerType*)infoList[i].imageLoadAddress;</span><br><span class="line">        <span class="keyword">if</span> (!hasLoadMethods(mhdr)) <span class="keyword">continue</span>;</span><br><span class="line">        prepare_load_methods(mhdr);</span><br><span class="line">        found = YES;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> found;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è°ƒç”¨ prepare_load_methods å¯¹ load æ–¹æ³•çš„è°ƒç”¨è¿›è¡Œå‡†å¤‡ï¼ˆå°†éœ€è¦è°ƒç”¨ load æ–¹æ³•çš„ç±»æ·»åŠ åˆ°ä¸€ä¸ªåˆ—è¡¨ä¸­ï¼Œåé¢çš„å°èŠ‚ä¸­ä¼šä»‹ç»ï¼‰ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">prepare_load_methods</span><span class="params">(<span class="keyword">const</span> headerType *mhdr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> count, i;</span><br><span class="line">    runtimeLock.assertWriting();</span><br><span class="line">    <span class="keyword">classref_t</span> *classlist = </span><br><span class="line">        _getObjc2NonlazyClassList(mhdr, &amp;count);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">        schedule_class_load(remapClass(classlist[i]));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">category_t</span> **categorylist = _getObjc2NonlazyCategoryList(mhdr, &amp;count);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">        <span class="keyword">category_t</span> *cat = categorylist[i];</span><br><span class="line">        Class cls = remapClass(cat-&gt;cls);</span><br><span class="line">        <span class="keyword">if</span> (!cls) <span class="keyword">continue</span>;  <span class="comment">// category for ignored weak-linked class</span></span><br><span class="line">        realizeClass(cls);</span><br><span class="line">        assert(cls-&gt;ISA()-&gt;isRealized());</span><br><span class="line">        add_category_to_loadable_list(cat);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡ _getObjc2NonlazyClassList è·å–æ‰€æœ‰çš„ç±»çš„åˆ—è¡¨ä¹‹åï¼Œä¼šé€šè¿‡ remapClass è·å–ç±»å¯¹åº”çš„æŒ‡é’ˆï¼Œç„¶åè°ƒç”¨ schedule_class_load é€’å½’åœ°å®‰æ’å½“å‰ç±»å’Œæ²¡æœ‰è°ƒç”¨ + load çˆ¶ç±»è¿›å…¥åˆ—è¡¨ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">schedule_class_load</span><span class="params">(Class cls)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!cls) <span class="keyword">return</span>;</span><br><span class="line">    assert(cls-&gt;isRealized());</span><br><span class="line">    <span class="keyword">if</span> (cls-&gt;data()-&gt;flags &amp; RW_LOADED) <span class="keyword">return</span>;</span><br><span class="line">    schedule_class_load(cls-&gt;superclass);</span><br><span class="line">    add_class_to_loadable_list(cls);</span><br><span class="line">    cls-&gt;setInfo(RW_LOADED); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨æ‰§è¡Œ add_class_to_loadable_list(cls) å°†å½“å‰ç±»åŠ å…¥åŠ è½½åˆ—è¡¨ä¹‹å‰ï¼Œä¼šå…ˆæŠŠçˆ¶ç±»åŠ å…¥å¾…åŠ è½½çš„åˆ—è¡¨ï¼Œä¿è¯çˆ¶ç±»åœ¨å­ç±»å‰è°ƒç”¨ load æ–¹æ³•ã€‚åœ¨å°†é•œåƒåŠ è½½åˆ°è¿è¡Œæ—¶ã€å¯¹ load æ–¹æ³•çš„å‡†å¤‡å°±ç»ªä¹‹åï¼Œæ‰§è¡Œ call_load_methodsï¼Œå¼€å§‹è°ƒç”¨ load æ–¹æ³•ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***********************************************************************</span></span><br><span class="line"><span class="comment">* call_load_methods</span></span><br><span class="line"><span class="comment">* Call all pending class and category +load methods.//è°ƒç”¨æ‰€æœ‰æ·»åŠ çš„ç±»å’Œç±»ç›®çš„ +loadæ–¹æ³•</span></span><br><span class="line"><span class="comment">* Class +load methods are called superclass-first.// ç±»çš„ +loadæ–¹æ³• ä¿è¯çˆ¶ç±»åœ¨å­ç±»å‰è°ƒç”¨ã€‚</span></span><br><span class="line"><span class="comment">* Category +load methods are not called until after the parent class's +load.//ç±»ç›®çš„+loadæ–¹æ³•è°ƒç”¨ åœ¨çˆ¶ç±»+loadæ–¹æ³•ä¹‹å</span></span><br><span class="line"><span class="comment">* </span></span><br><span class="line"><span class="comment">* This method must be RE-ENTRANT, because a +load could trigger </span></span><br><span class="line"><span class="comment">* more image mapping. In addition, the superclass-first ordering </span></span><br><span class="line"><span class="comment">* must be preserved in the face of re-entrant calls. Therefore, </span></span><br><span class="line"><span class="comment">* only the OUTERMOST call of this function will do anything, and </span></span><br><span class="line"><span class="comment">* that call will handle all loadable classes, even those generated </span></span><br><span class="line"><span class="comment">* while it was running.</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* The sequence below preserves +load ordering in the face of </span></span><br><span class="line"><span class="comment">* image loading during a +load, and make sure that no </span></span><br><span class="line"><span class="comment">* +load method is forgotten because it was added during </span></span><br><span class="line"><span class="comment">* a +load call.</span></span><br><span class="line"><span class="comment">* Sequence:</span></span><br><span class="line"><span class="comment">* 1. Repeatedly call class +loads until there aren't any more</span></span><br><span class="line"><span class="comment">* 2. Call category +loads ONCE.</span></span><br><span class="line"><span class="comment">* 3. Run more +loads if:</span></span><br><span class="line"><span class="comment">*    (a) there are more classes to load, OR</span></span><br><span class="line"><span class="comment">*    (b) there are some potential category +loads that have </span></span><br><span class="line"><span class="comment">*        still never been attempted.</span></span><br><span class="line"><span class="comment">* Category +loads are only run once to ensure "parent class first" </span></span><br><span class="line"><span class="comment">* ordering, even if a category +load triggers a new loadable class </span></span><br><span class="line"><span class="comment">* and a new loadable category attached to that class. </span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* Locking: loadMethodLock must be held by the caller </span></span><br><span class="line"><span class="comment">*   All other locks must not be held.</span></span><br><span class="line"><span class="comment">**********************************************************************/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">call_load_methods</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">bool</span> loading = NO;</span><br><span class="line">    <span class="keyword">bool</span> more_categories;</span><br><span class="line"></span><br><span class="line">    loadMethodLock.assertLocked();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Re-entrant calls do nothing; the outermost call will finish the job.</span></span><br><span class="line">    <span class="keyword">if</span> (loading) <span class="keyword">return</span>;</span><br><span class="line">    loading = YES;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> *pool = objc_autoreleasePoolPush();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">// 1. Repeatedly call class +loads until there aren't any more</span></span><br><span class="line">        <span class="keyword">while</span> (loadable_classes_used &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            call_class_loads();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. Call category +loads ONCE</span></span><br><span class="line">        more_categories = call_category_loads();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. Run more +loads if there are classes OR more untried categories</span></span><br><span class="line">    &#125; <span class="keyword">while</span> (loadable_classes_used &gt; <span class="number">0</span>  ||  more_categories);</span><br><span class="line"></span><br><span class="line">    objc_autoreleasePoolPop(pool);</span><br><span class="line"></span><br><span class="line">    loading = NO;</span><br></pre></td></tr></table></figure>

<p>æ–¹æ³•çš„è°ƒç”¨æµç¨‹å¤§æ¦‚æ˜¯è¿™æ ·çš„ï¼š</p>
<img src="/blog/runtime%E5%AD%A6%E4%B9%A0%E4%B8%80/call_load_methods%E6%96%B9%E6%B3%95%E8%B0%83%E7%94%A8%E6%B5%81%E7%A8%8B%E5%9B%BE.png" class="" title="call_load_methodsæ–¹æ³•è°ƒç”¨æµç¨‹å›¾.png">

<p>å…¶ä¸­call_class_loads ä¼šä»ä¸€ä¸ªå¾…åŠ è½½çš„ç±»åˆ—è¡¨ loadable_classes ä¸­å¯»æ‰¾å¯¹åº”çš„ç±»ï¼Œç„¶åæ‰¾åˆ° @selector(load) çš„å®ç°å¹¶æ‰§è¡Œã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">call_class_loads</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">loadable_class</span> *<span class="title">classes</span> = <span class="title">loadable_classes</span>;</span></span><br><span class="line">    <span class="keyword">int</span> used = loadable_classes_used;</span><br><span class="line">    loadable_classes = nil;</span><br><span class="line">    loadable_classes_allocated = <span class="number">0</span>;</span><br><span class="line">    loadable_classes_used = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; used; i++) &#123;</span><br><span class="line">        Class cls = classes[i].cls;</span><br><span class="line">        <span class="keyword">load_method_t</span> load_method = (<span class="keyword">load_method_t</span>)classes[i].method;</span><br><span class="line">        <span class="keyword">if</span> (!cls) <span class="keyword">continue</span>;</span><br><span class="line">        (*load_method)(cls, SEL_load);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (classes) <span class="built_in">free</span>(classes);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™è¡Œ (*load_method)(cls, SEL_load) ä»£ç å°±ä¼šè°ƒç”¨ç±»ä¸­çš„+loadæ–¹æ³•ã€‚<br>è‡³æ­¤ï¼šQï¼šload æ–¹æ³•æ˜¯å¦‚ä½•è¢«è°ƒç”¨çš„ï¼Ÿ<br>Aï¼šå½“ Objective-C è¿è¡Œæ—¶åˆå§‹åŒ–çš„æ—¶å€™ï¼Œä¼šé€šè¿‡ dyld_register_image_state_change_handler åœ¨æ¯æ¬¡æœ‰æ–°çš„é•œåƒåŠ å…¥è¿è¡Œæ—¶çš„æ—¶å€™ï¼Œè¿›è¡Œå›è°ƒã€‚æ‰§è¡Œ load_images å°†æ‰€æœ‰åŒ…å« load æ–¹æ³•çš„æ–‡ä»¶åŠ å…¥åˆ—è¡¨ loadable_classes ï¼Œç„¶åä»è¿™ä¸ªåˆ—è¡¨ä¸­æ‰¾åˆ°å¯¹åº”çš„ load æ–¹æ³•çš„å®ç°ï¼Œè°ƒç”¨ load æ–¹æ³•ã€‚</p>
<h6 id="loadable-classesæ˜¯æ€ä¹ˆç®¡ç†çš„ï¼Ÿ"><a href="#loadable-classesæ˜¯æ€ä¹ˆç®¡ç†çš„ï¼Ÿ" class="headerlink" title="loadable_classesæ˜¯æ€ä¹ˆç®¡ç†çš„ï¼Ÿ"></a>loadable_classesæ˜¯æ€ä¹ˆç®¡ç†çš„ï¼Ÿ</h6><p>1ã€ObjC å¯¹äºåŠ è½½çš„ç®¡ç†ï¼Œä¸»è¦ä½¿ç”¨äº†ä¸¤ä¸ªåˆ—è¡¨ï¼Œåˆ†åˆ«æ˜¯ loadable_classes å’Œ loadable_categoriesã€‚</p>
<p>æ–¹æ³•çš„è°ƒç”¨è¿‡ç¨‹ä¹Ÿåˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼Œå‡†å¤‡ load æ–¹æ³•å’Œè°ƒç”¨ load æ–¹æ³•ï¼Œæˆ‘æ›´è§‰å¾—è¿™ä¸¤ä¸ªéƒ¨åˆ†æ¯”è¾ƒåƒç”Ÿäº§è€…ä¸æ¶ˆè´¹è€…ï¼š</p>
<img src="/blog/runtime%E5%AD%A6%E4%B9%A0%E4%B8%80/loadable_classes%E5%88%97%E8%A1%A8%E7%9A%84%E7%AE%A1%E7%90%86.png" class="" title="loadable_classesåˆ—è¡¨çš„ç®¡ç†.png">

<p>add_class_to_loadable_list æ–¹æ³•è´Ÿè´£å°†ç±»åŠ å…¥ loadable_classes é›†åˆï¼Œè€Œ call_class_loads è´Ÿè´£æ¶ˆè´¹é›†åˆä¸­çš„å…ƒç´ ã€‚è€Œå¯¹äºåˆ†ç±»æ¥è¯´ï¼Œå…¶æ¨¡å‹ä¹Ÿæ˜¯ç±»ä¼¼çš„ï¼Œåªä¸è¿‡ä½¿ç”¨äº†å¦ä¸€ä¸ªåˆ—è¡¨ loadable_categoriesã€‚</p>
<p>2ã€â€œç”Ÿäº§â€ loadable_class</p>
<p>3ã€â€œæ¶ˆè´¹â€ loadable_class</p>
<p>å…³äºéªŒè¯å¯å‚è€ƒ <a href="https://github.com/draveness/analyze/blob/master/contents/objc/æ·±å…¥è§£æ%20ObjC%20ä¸­æ–¹æ³•çš„ç»“æ„.md#æ·±å…¥è§£æ-objc-ä¸­æ–¹æ³•çš„ç»“æ„" target="_blank" rel="noopener">https://github.com/draveness/analyze/blob/master/contents/objc/æ·±å…¥è§£æ%20ObjC%20ä¸­æ–¹æ³•çš„ç»“æ„.md#æ·±å…¥è§£æ-objc-ä¸­æ–¹æ³•çš„ç»“æ„</a> </p>
<p>å‚è€ƒï¼š<a href="https://halfrost.com/objc_runtime_isa_class/" target="_blank" rel="noopener">https://halfrost.com/objc_runtime_isa_class/</a><br><a href="https://www.jianshu.com/p/4546f22b2e96" target="_blank" rel="noopener">https://www.jianshu.com/p/4546f22b2e96</a></p>
<p><a href="https://blog.csdn.net/shengpeng3344/article/details/105800310?utm_medium=distribute.pc_relevant.none-task-blog-baidujs-1" target="_blank" rel="noopener">https://blog.csdn.net/shengpeng3344/article/details/105800310?utm_medium=distribute.pc_relevant.none-task-blog-baidujs-1</a></p>
<p>ä½ çœŸçš„äº†è§£loadæ–¹æ³•ä¹ˆï¼Ÿ<a href="https://blog.csdn.net/u011303663/article/details/51553489" target="_blank" rel="noopener">https://blog.csdn.net/u011303663/article/details/51553489</a></p>

      
       <hr><span style="font-style: italic;color: gray;"> è½¬è½½è¯·æ³¨æ˜æ¥æºï¼Œæ¬¢è¿å¯¹æ–‡ç« ä¸­çš„å¼•ç”¨æ¥æºè¿›è¡Œè€ƒè¯ï¼Œæ¬¢è¿æŒ‡å‡ºä»»ä½•æœ‰é”™è¯¯æˆ–ä¸å¤Ÿæ¸…æ™°çš„è¡¨è¾¾ã€‚å¯ä»¥åœ¨ä¸‹é¢è¯„è®ºåŒºè¯„è®ºï¼Œä¹Ÿå¯ä»¥é‚®ä»¶è‡³ jaytp@qq.com </span>
    </div>
</article>


<p>
    <a  class="dashang" onclick="dashangToggle()">ğŸ’°</a>
</p>






    




    </div>
    <div class="copyright">
        <p class="footer-entry">
    Â©2016-2020 Yelog
</p>
<p class="footer-entry">Built with <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/yelog/hexo-theme-3-hexo" target="_blank">3-hexo</a> theme</p>

    </div>
    <div class="full-toc">
        <button class="full" data-title="åˆ‡æ¢å…¨å± å¿«æ·é”® s"><span class="min "></span></button>
<a class="" id="rocket" ></a>

    </div>
</div>

<div class="hide_box" onclick="dashangToggle()"></div>
<div class="shang_box">
    <a class="shang_close"  onclick="dashangToggle()">Ã—</a>
    <div class="shang_tit">
        <p>Help us with donation</p>
    </div>
    <div class="shang_payimg">
        <div class="pay_img">
            <img src="/blog/img/alipay.jpg" class="alipay" title="æ‰«ç æ”¯æŒ">
            <img src="/blog/img/weixin.jpg" class="weixin" title="æ‰«ç æ”¯æŒ">
        </div>
    </div>
    <div class="shang_payselect">
        <span><label><input type="radio" name="pay" checked value="alipay">alipay</label></span><span><label><input type="radio" name="pay" value="weixin">weixin</label></span>
    </div>
</div>


</body>
<script src="/blog/js/jquery.pjax.js?v=1.1.0" ></script>

<script src="/blog/js/script.js?v=1.1.0" ></script>
<script>
    var img_resize = 'default';
    function initArticle() {
        /*æ¸²æŸ“å¯¹åº”çš„è¡¨æ ¼æ ·å¼*/
        
            $("#post .pjax table").addClass("green_title");
        

        /*æ¸²æŸ“æ‰“èµæ ·å¼*/
        
        $("input[name=pay]").on("click", function () {
            if($("input[name=pay]:checked").val()=="weixin"){
                $(".shang_box .shang_payimg .pay_img").addClass("weixin_img");
            } else {
                $(".shang_box .shang_payimg .pay_img").removeClass("weixin_img");
            }
        })
        

        /*é«˜äº®ä»£ç å—è¡Œå·*/
        

        /*è®¿é—®æ•°é‡*/
        
        $.getScript("//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js");
        

        /*ä»£ç é«˜äº®ï¼Œè¡Œå·å¯¹é½*/
        $('.pre-numbering').css('line-height',$('.has-numbering').css('line-height'));

        
        
    }

    /*æ‰“èµé¡µé¢éšè—ä¸å±•ç¤º*/
    
    function dashangToggle() {
        $(".shang_box").fadeToggle();
        $(".hide_box").fadeToggle();
    }
    

</script>

<!--åŠ å…¥è¡Œå·çš„é«˜äº®ä»£ç å—æ ·å¼-->

<!--è‡ªå®šä¹‰æ ·å¼è®¾ç½®-->
<style>
    
    
    .nav {
        width: 542px;
    }
    .nav.fullscreen {
        margin-left: -542px;
    }
    .nav-left {
        width: 120px;
    }
    
    
    @media screen and (max-width: 1468px) {
        .nav {
            width: 492px;
        }
        .nav.fullscreen {
            margin-left: -492px;
        }
        .nav-left {
            width: 100px;
        }
    }
    
    
    @media screen and (max-width: 1024px) {
        .nav {
            width: 492px;
            margin-left: -492px
        }
        .nav.fullscreen {
            margin-left: 0;
        }
    }
    
    @media screen and (max-width: 426px) {
        .nav {
            width: 100%;
        }
        .nav-left {
            width: 100%;
        }
    }
    
    
    .nav-right .title-list nav a .post-title, .nav-right .title-list #local-search-result a .post-title {
        color: #383636;
    }
    
    
    .nav-right .title-list nav a .post-date, .nav-right .title-list #local-search-result a .post-date {
        color: #5e5e5f;
    }
    
    
    .nav-right nav a.hover, #local-search-result a.hover{
        background-color: #e2e0e0;
    }
    
    

    /*åˆ—è¡¨æ ·å¼*/
    

    /* èƒŒæ™¯å›¾æ ·å¼ */
    
    


    /*å¼•ç”¨å—æ ·å¼*/
    

    /*æ–‡ç« åˆ—è¡¨èƒŒæ™¯å›¾*/
    

    
</style>







</html>
